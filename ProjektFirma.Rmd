---
title: ""
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
runtime: shiny
---


```{r knitr_init, echo=FALSE, cache=FALSE}
library(knitr)
library(rmdformats)


## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```
# Loading packages

```{r}
library(tidyverse)
library(lubridate)
library(normalr)
library(formatR)
library(gridExtra)
library(plotly)
library(shiny)
library(DT)
```


# Welcome to my presentation

This is a presentation about my own company "Verture Farm". This data is saved about the month Juli, August, September and October. First of all i will look on some visualizations about the harvest data and analyse it. After that i want to add the weather data to the harvest data to analyse the dependency between the amount of harvest and the weather.

# Load Data

First of all we have to load the data.

```{r echo=TRUE}
df <- readRDS("Erntetabelle.rds")
```

Than lets view the data.

```{r}
# view(df) 
```

We see that there a lot of NA values. Lets tidy up the NA values.

```{r}
df <- df %>% select(-`Packungen Verkauft Marktschwärmer`) %>%
  drop_na()

```

Manipulate the Date and add an interval, week and some other columns.

```{r}
df$Erntedatum <- ymd(df$Erntedatum)
df$Aussaat <- ymd(df$Aussaat)

df <- df %>%
  mutate(Zeitstrecke = interval(ymd(Aussaat), ymd(Erntedatum)))

df <- df %>%
  mutate(woche = week(df$Erntedatum))

```

If you want to save all your datawrangling than use the save function.

```{r}
#saveRDS(df,"Erntetabelle.rds)
```


# The average amount of harvest

Here we get the average amount of harvest per variety. I filtert out the varieties where we only got a few crops. So we concentrate on the varieties which are common. There "Radieschen rot", "Daikon Rettich", "Brokkoli", "Senf", "Sonnenblumen" und "Erbsen". 

```{r}
df %>% filter(Sorte != "Bockshornklee", Sorte != "Mizuna", Sorte != "Rote Bete", Sorte != "Kohlrabi rot", Sorte != "Koriander") %>%
  group_by(Sorte) %>%
  summarise(Durchschnittserntemenge = mean(`Geerntet in gramm`/`Anzahl Trays`), avg_profit_per_tray = mean(`Gewinn pro Tray bei Marktschwärmer`)) %>%
  ggplot(aes(x = reorder(Sorte,Durchschnittserntemenge), y = Durchschnittserntemenge, fill = avg_profit_per_tray)) +
  geom_col() +
  coord_flip() +
  xlab("Variety") +
  ylab("Average amount of harvest in g")
  


```


# Average time of grown

```{r}
df %>% filter(Sorte != "Bockshornklee", Sorte != "Mizuna", Sorte != "Rote Bete", Sorte != "Kohlrabi rot", Sorte != "Koriander") %>%
  group_by(Sorte) %>%
  summarise(avg_time = mean(Anbauzeit)) %>%
  ggplot(aes(x = reorder(Sorte, avg_time), y = avg_time)) +
  geom_col() +
  coord_flip() +
  ylab("Average time of growth in d")
```


# Time of growth over time

```{r}
df %>% filter(Sorte != "Bockshornklee", Sorte != "Mizuna", Sorte != "Rote Bete", Sorte != "Kohlrabi rot", Sorte != "Koriander") %>%
  group_by(Sorte) %>%
  ggplot(aes(x = Erntedatum, y = Anbauzeit, colour = Sorte)) +
  geom_line() + 
  geom_point() 

```


# Lets look some variables over time

```{r}
df %>% filter(Sorte != "Bockshornklee", Sorte != "Mizuna", Sorte != "Rote Bete", Sorte != "Kohlrabi rot", Sorte != "Koriander") %>%
  ggplot(aes(x = Erntedatum, y = `Gramm pro Tray`, colour = Sorte)) +
  geom_line() + 
  geom_point() 

df %>%
  filter(Sorte != "Bockshornklee", Sorte != "Mizuna", Sorte != "Rote Bete", Sorte != "Kohlrabi rot", Sorte != "Koriander") %>%
  group_by(wochen = week(Erntedatum)) %>%
  summarise(avg_harvest = mean(`Gramm pro Tray`)) %>%
  ggplot(aes(x = wochen, y = avg_harvest)) +
  geom_line()
  

```


Lets add the filter function to our data.frame.

```{r}
df1 <-df %>% filter(Sorte != "Bockshornklee", Sorte != "Mizuna", Sorte != "Rote Bete", Sorte != "Kohlrabi rot", Sorte != "Koriander")
```

# Amount of Trays

```{r}
df %>% summarise(AmountTrays = sum(`Anzahl Trays`, na.rm = TRUE))

df %>% summarise(PossibleProfit = sum(`Anzahl Trays`, na.rm = TRUE)*450/1000*30)
```



# Lets check the weather

First of all we have to load some data.

```{r}
produkt_klima_tag_20180517_20191117_02564 <- read_delim("dataaktl/produkt_klima_tag_20180517_20191117_02564.txt", 
    ";", escape_double = FALSE, trim_ws = TRUE)
```


Lets put the original data to a other data.frame and change the date column.

```{r}
weather <- produkt_klima_tag_20180517_20191117_02564
weather$MESS_DATUM <- ymd(weather$MESS_DATUM)
```
 
 Lets have a look on the weather data with a little plot but beforehand we shut just choose the date where the farm was producing. Here we see the column names and their meaning.
 
 FM : Daily mean of the wind speed in m/s
 FX : Maxima of the wind peak m/sec
 NM : Tagesmittel des Bedeckungsgrades in Achteln
 PM : Tagesmittel des Luftdrucks in hpa
 RSK : tgl. Niederschlagshöhe in mm
 RSKF : tgl. Niederschlagsform im numerischen Code
 SDK : Sonnenscheindauer in h
 SHK_TAG : Schneehoeher Tageswert in cm
 TGK : Minimum der Lufttemperatur am ERdboden in 5 cm Hoehe in °C
 TMK : Tagesmittel der Temperatur in °C
 TNK : Tagesminimum der Lufttemperatur in 2 m Hoehe in °C
 TXK : Tagesmaximum der Lufttemperatur in 2 m Hoehe in °C
 UPM : Tagesmittel der Relativen Feuchte in %
 VPM : Tagesmittel des DAmpfdruckes in hpa
 
```{r}
weather <- weather %>% filter(year(weather$MESS_DATUM) == 2019, yday(weather$MESS_DATUM) >= 182, yday(weather$MESS_DATUM) <= 295) 

weather <- weather %>% 
  mutate(woche = week(weather$MESS_DATUM))

weather %>%
  ggplot(aes(x= MESS_DATUM, y = TMK)) +
  geom_point()
  
#  year(weather$MESS_DATUM)  # Gibt das Jahr aus für alle Daten im df
#  date(weather$MESS_DATUM)  # Gibt das Datum aus für alle Daten im df
#  ymd(20190701)             # Gibt das Datum für den eingegebenen Zeitpunkt aus
#  yday(ymd(20190701))       # Gibt den Tag im Jahr aus für das eingegebene Datum
#  yday(weather$MESS_DATUM)  # Gibt den Tag im Jahr für alle Daten im df
#  weather$MESS_DATUM        # Gibt alle Daten aus für alle Daten im df
 
```
 
 Try to get information for the plots from two different datasets.
 
```{r}

b1 <- ggplot() +
  geom_point(data = weather, aes(x = MESS_DATUM, y = TNK)) +
  geom_smooth(data = weather, aes(x = MESS_DATUM, y = TNK)) 
b2 <- ggplot() +
  geom_smooth(data = df1, aes(x = Erntedatum, y = Anbauzeit), show.legend = FALSE)

grid.arrange(b1,b2)

```
 
 Some data wrangling to do better visualizations. I added some average temperatures to the havest data.frame.
 
```{r include=FALSE}

weather1 <- weather %>%
  group_by(woche) %>%
  summarise(avg_tnk_week = mean(TNK), avg_txk_week = mean(TXK))

df2 <- inner_join(df1, weather1,by = c("woche"))

```
 
 Take a look on the average harvest about the weeks.
 
```{r}
p1 <- df2 %>%
  group_by(woche)

p1 <- p1 %>%
  summarise(avg_harvest = mean(`Gramm pro Tray`), avg_tnk_week = mean(avg_tnk_week), avg_txk_week = mean(avg_txk_week)) %>%
  ggplot(aes(x = woche, y = avg_harvest))  +
  geom_line() +
  geom_smooth()

p1

p1 +
  geom_point(aes(size = avg_tnk_week, colour = avg_txk_week))


```
 
 Create a line for every variety.
 
```{r}
p2 <- df2 %>%
  group_by(woche, Sorte)

p2 %>%
  summarise(avg_harvest = mean(`Gramm pro Tray`)) %>%
  ggplot(aes(x = woche, y = avg_harvest, colour = Sorte)) +
  geom_line()
 
```
 
 Add some more layers and tidy up the varieties.
 
```{r}
p2 %>%
  summarise(avg_harvest = mean(`Gramm pro Tray`)) %>%
  ggplot(aes(x = woche, y = avg_harvest)) +
  geom_line() +
  facet_wrap(~ Sorte)

  
```
 
 
 To put the two datasets into one plot we have to normalize the numeric numbers or we use a grid.Extra package to show the different plots above each other.
 
```{r}

p3 <- weather %>%
  ggplot(aes(x = woche, y = TNK)) +
  geom_point(colour = "blue") +
  geom_point(aes(x = woche, y = TXK), colour = "red")

grid.arrange(p1,p3)


```
 
 
 Lets have a look on the amount of trays per week.
 
```{r}
p4 <- df2 %>%
  group_by(woche) %>%
  summarise(amountTrays = sum(`Anzahl Trays`), amountGramm = sum(`Geerntet in gramm`), avg_tnk_week = mean(avg_tnk_week)) %>%
  ggplot(aes(x = woche, y = amountTrays, size = amountGramm, colour = avg_tnk_week)) +
  geom_point() +
  geom_smooth() 

ggplotly(p4, tooltip = c("colour", "size"))
  

```
 
 
 Some interactive webapp with shiny. But first we have to clean some columns out of our data frame.
 
```{r}
weather <- weather %>%
  select(-QN_3, -QN_4, -SDK, -SHK_TAG, -eor, -STATIONS_ID)
```
 
 
```{r}
shinyApp(

  ui = fluidPage(
    titlePanel("Interactive visualization via shinyapp"),
    sidebarLayout(
          sidebarPanel(
            conditionalPanel(
              'input.dataset === "weather"',
              selectInput("select1", "Choose x variable", names(weather)),
              selectInput("select2", "Choose y variable", names(weather)),
              selectInput("select3", "Choose size/colour Variable", names(weather)),
              selectInput("group", "Choose a grouping option", choices = c("woche", "MESS_DATUM"))
            ),
            conditionalPanel(
              'input.dataset === "df2"',
              selectInput("select4", "Choose some variables", choices = names(df2), selected = "woche"),
              selectInput("select5", "Choose y variable", names(df2)),
              selectInput("select6", "Choose size Variable", names(df2)),
              selectInput("group2", "Choose a grouping option", choices = c("woche", "Sorte"))
            )
    
          ),
          mainPanel(
            tabsetPanel(
              id = 'dataset',
              tabPanel("weather",
                       dataTableOutput("table1"),
                       plotlyOutput("weather_plot")
                       ),
              tabPanel("df2",
                       dataTableOutput("table2"),
                       plotlyOutput("df2_plot")
                       )
            )
          )
    )
  ),

  server = function(input, output) {
    
    grouped_weather <- reactive({
      switch (input$group,
        "woche" = weather %>% group_by(woche),
        "MESS_DATUM" = weather %>% group_by(MESS_DATUM)
      )
    })
    grouped_df2 <- reactive({
      switch (input$group2,
        "woche" = df2 %>% group_by(woche) %>% summarise(variable4 = mean(get(input$select4)), variable5 = mean(get(input$select5)), variable6 = mean(get(input$select6))) %>%
        plot_ly(x = ~variable4, y=~variable5, size = ~variable6, type=switch_type()),
        "Sorte" = df2 %>% group_by(Sorte) %>% summarise(variable5 = mean(get(input$select5)), variable6 = mean(get(input$select6))) %>%
        plot_ly(x = ~Sorte, y=~variable5, fill = ~variable6, type=switch_type())
      )
    })
    switch_type <- reactive({
      switch (input$group2,
        "woche" = "scatter",
        "Sorte" = "bar"
      )
    })
    
    
    output$table1 <- renderDataTable({
      datatable(weather)
    })
    output$table2 <- renderDataTable({
      datatable(df2)
    })
    output$weather_plot <- renderPlotly({
      
      grouped_weather() %>%
        summarise(variable1 = mean(get(input$select1)), variable2 = mean(get(input$select2)), variable3 = mean(get(input$select3))) %>%
        plot_ly(x = ~variable1, y=~variable2, size = ~variable3, type="scatter", mode="lines+markers") 
    })
    output$df2_plot <- renderPlotly({
      grouped_df2()
    })
    
  },

  options = list(height = 500)
)

```
 
 
```{r}
df2 %>%
  group_by(Sorte) %>%
  summarise(avg_per_tray = mean(`Gramm pro Tray`), avg_profit = mean(`Gewinn pro Tray bei Marktschwärmer`)) %>%
  plot_ly(x = ~Sorte, y = ~avg_per_tray, fill = ~avg_profit, type = "box")

class(df)
class(weather)
```
 
 